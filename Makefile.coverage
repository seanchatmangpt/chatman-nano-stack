# CNS Coverage Build Configuration
# Include this in main Makefile with: include Makefile.coverage

# Coverage compilation flags
COVERAGE_FLAGS = -fprofile-instr-generate -fcoverage-mapping -fcoverage-mcdc
COVERAGE_CFLAGS = $(CFLAGS) $(COVERAGE_FLAGS)

# Coverage profile settings
export LLVM_PROFILE_FILE = coverage/profiles/cns_coverage_%p_%m.profraw

# Coverage targets
.PHONY: coverage-clean coverage-build coverage-test coverage-report coverage-summary

coverage-clean:
	@echo "ğŸ§¹ Cleaning coverage data..."
	@rm -rf coverage/profiles/*.profraw coverage/reports/* coverage/*.profdata

coverage-build: coverage-clean
	@echo "ğŸ”¨ Building with coverage instrumentation..."
	@$(MAKE) clean
	@$(MAKE) CC=clang CFLAGS="$(COVERAGE_CFLAGS)" all

coverage-test: coverage-build
	@echo "ğŸ§ª Running tests with coverage collection..."
	@cd tests && $(MAKE) test-bdd CC=clang CFLAGS="$(COVERAGE_CFLAGS)"
	@cd bitactor/tests && $(MAKE) test CC=clang CFLAGS="$(COVERAGE_CFLAGS)"

coverage-merge:
	@echo "ğŸ“Š Merging coverage profiles..."
	@llvm-profdata merge -sparse coverage/profiles/*.profraw -o coverage/cns_coverage.profdata

coverage-report: coverage-test coverage-merge
	@echo "ğŸ“ˆ Generating HTML coverage report..."
	@mkdir -p coverage/reports
	@llvm-cov show ./cns -instr-profile=coverage/cns_coverage.profdata \
		-format=html -output-dir=coverage/reports \
		-show-line-counts -show-regions -show-expansions
	@echo "Coverage report generated: coverage/reports/index.html"

coverage-summary: coverage-merge
	@echo "ğŸ“‹ Coverage Summary:"
	@echo "==================="
	@llvm-cov report ./cns -instr-profile=coverage/cns_coverage.profdata \
		-show-functions -show-regions

coverage-check: coverage-merge
	@echo "ğŸš¦ Checking coverage thresholds..."
	@$(SCRIPTS_DIR)/check_coverage_gate.sh

coverage-lcov: coverage-merge
	@echo "ğŸ“¤ Generating LCOV format for external tools..."
	@llvm-cov export ./cns -instr-profile=coverage/cns_coverage.profdata -format=lcov > coverage/coverage.lcov

# Development helpers
coverage-file-%: coverage-merge
	@echo "ğŸ“ Coverage for file: src/$*.c"
	@llvm-cov show ./cns -instr-profile=coverage/cns_coverage.profdata src/$*.c \
		-show-line-counts -format=text

coverage-function-%: coverage-merge
	@echo "ğŸ” Coverage for function: $*"
	@llvm-cov report ./cns -instr-profile=coverage/cns_coverage.profdata \
		-show-functions | grep "$*" || echo "Function $* not found"
