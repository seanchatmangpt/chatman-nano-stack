/**
 * BitActor Implementation - Generated from 
 * 8-tick performance guarantee with semantic signal processing
 * Generated by CNS Jinja AOT Compiler
 */

#ifndef CNSFORGE_H
#define CNSFORGE_H

#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include <time.h>

/* Platform-specific cycle counter */
#if defined(__x86_64__) || defined(__i386__)
    #include <x86intrin.h>
    static inline uint64_t rdtsc() { return __rdtsc(); }
#elif defined(__aarch64__)
    static inline uint64_t rdtsc() {
        uint64_t val;
        __asm__ volatile("mrs %0, cntvct_el0" : "=r" (val));
        return val;
    }
#elif defined(__arm__)
    static inline uint64_t rdtsc() {
        #if (__ARM_ARCH >= 6)
            uint32_t val;
            __asm__ volatile("mrc p15, 0, %0, c9, c13, 0" : "=r"(val));
            return val;
        #else
            struct timespec ts;
            clock_gettime(CLOCK_MONOTONIC, &ts);
            return ts.tv_sec * 1000000000ULL + ts.tv_nsec;
        #endif
    }
#else
    static inline uint64_t rdtsc() {
        struct timespec ts;
        clock_gettime(CLOCK_MONOTONIC, &ts);
        return ts.tv_sec * 1000000000ULL + ts.tv_nsec;
    }
#endif

/* Constants from TTL ontology */
#define CNSFORGE_MAX_SIGNALS      256
#define CNSFORGE_RING_SIZE        4096
/* Tick budget: 8 CPU cycles on x86, ~10ns on ARM */
#if defined(__x86_64__) || defined(__i386__)
#define CNSFORGE_TICK_BUDGET      8
#else
#define CNSFORGE_TICK_BUDGET      10000  /* 10 microseconds for non-x86 */
#endif

/* Signal types from ontology */
typedef enum {
    CNSFORGE_SIGNAL_THREAT_DETECTED = 1,
    CNSFORGE_SIGNAL_SYSTEM_ALERT = 2,
    CNSFORGE_SIGNAL_NETWORK_EVENT = 3,
    CNSFORGE_SIGNAL_GOSSIP_MESSAGE = 4,
    CNSFORGE_SIGNAL_MAX
} cnsforge_signal_type_t;

/* Signal structure */
typedef struct {
    uint32_t type;
    uint32_t flags;
    uint64_t timestamp;
    uint64_t payload;
} cnsforge_signal_t;

/* Handler function type */
typedef void (*cnsforge_handler_fn)(cnsforge_signal_t* sig, void* scratch);

/* BitActor state */
typedef struct {
    cnsforge_signal_t signal_ring[CNSFORGE_RING_SIZE];
    volatile uint32_t signal_head;
    volatile uint32_t signal_tail;
    
    uint8_t scratch[2048] __attribute__((aligned(64)));
    cnsforge_handler_fn dispatch[1024];
    
    uint64_t tick_count;
    uint64_t signal_count;
} cnsforge_bitactor_t;

/* Core API */
void cnsforge_bitactor_init(cnsforge_bitactor_t* ba);
void cnsforge_bitactor_tick(cnsforge_bitactor_t* ba);
bool cnsforge_bitactor_enqueue_signal(cnsforge_bitactor_t* ba, const cnsforge_signal_t* sig);

/* Generated handlers from TTL */
void cnsforge_handle_threat_detector(cnsforge_signal_t* sig, void* scratch);
void cnsforge_handle_system_alerter(cnsforge_signal_t* sig, void* scratch);

#endif /* CNSFORGE_H */

/* Implementation */
#endif